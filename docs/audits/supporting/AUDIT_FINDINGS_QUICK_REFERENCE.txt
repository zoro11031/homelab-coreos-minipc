================================================================================
AUDIT FINDINGS - QUICK REFERENCE
================================================================================

HIGH SEVERITY ISSUES (Fix Immediately)
================================================================================

ISSUE #1: COMMAND INJECTION - NFS MOUNT CONFIGURATION
  Severity: HIGH
  Category: Security
  File: /home/user/homelab-coreos-minipc/homelab-setup/internal/steps/nfs.go
  Lines: 251, 263
  Problem: User input passed to shell commands without proper validation
  Type: "sudo -n mount <MOUNT_POINT>" vulnerability
  Proof of Concept: "/mnt/test; rm -rf /"
  Status: REQUIRES IMMEDIATE FIX

ISSUE #2: UNCHECKED CONFIG.SET() ERRORS  
  Severity: HIGH
  Category: Data Integrity
  File: /home/user/homelab-coreos-minipc/homelab-setup/internal/steps/container.go
  Lines: 379, 388, 404, 422, 428, 434, 440, 451, 455, 466, 473, 480
  Count: 12 instances
  Problem: Silent configuration failures could corrupt state
  Examples:
    - Line 379: c.config.Set("PLEX_CLAIM_TOKEN", plexClaim) [no error check]
    - Line 422: c.config.Set("NEXTCLOUD_ADMIN_USER", nextcloudAdminUser) [no error check]
  Status: REQUIRES IMMEDIATE FIX


MEDIUM SEVERITY ISSUES (Fix Before Release)
================================================================================

ISSUE #3: TEST FAILURE - CONFIG ISOLATION
  Severity: MEDIUM
  Category: Test Defect
  File: /home/user/homelab-coreos-minipc/homelab-setup/internal/steps/container_test.go
  Lines: 220-231
  Test Name: TestContainerSetupServiceDirectoryFallback
  Problem: Test fails because HOMELAB_BASE_DIR persists from previous test
  Expected: /legacy/web
  Actual: /mnt/homelab/web
  Status: FIX REQUIRED

ISSUE #4: RACE CONDITION - MARKER CREATION
  Severity: MEDIUM
  Category: Race Condition
  File: /home/user/homelab-coreos-minipc/homelab-setup/internal/steps/marker_helpers.go
  Lines: 7-38 (function: ensureCanonicalMarker)
  Problem: TOCTOU race between Exists() check and Create()
  Timing: Between line 21 (Exists check) and line 29 (Create)
  Status: REQUIRES ATOMIC OPERATION FIX

ISSUE #5: SILENT ERRORS IN TEMPLATE DISCOVERY
  Severity: MEDIUM
  Category: Silent Error Handling
  File: /home/user/homelab-coreos-minipc/homelab-setup/internal/steps/container.go
  Lines: 60-68
  Function: FindTemplateDirectory()
  Problem: DirectoryExists() and countYAMLFiles() errors ignored
  Line 60: if exists, _ := c.fs.DirectoryExists(templateDirHome)
  Line 62: count, _ := c.countYAMLFiles(templateDirHome)
  Status: FIX REQUIRED

ISSUE #6: WORKING DIRECTORY NOT RESTORED
  Severity: MEDIUM
  Category: Resource Leak
  File: /home/user/homelab-coreos-minipc/homelab-setup/internal/steps/deployment.go
  Lines: 198-205
  Function: PullImages()
  Problem: Deferred os.Chdir() doesn't check errors
  Specific Line: 205 - defer os.Chdir(originalDir)
  Status: FIX REQUIRED

ISSUE #7: WIREGUARD CONFIG FORMATTING ERROR
  Severity: MEDIUM
  Category: Configuration Error
  File: /home/user/homelab-coreos-minipc/homelab-setup/internal/steps/wireguard.go
  Line: 184
  Problem: Extra space in PrivateKey field
  Current: " PrivateKey = %s"
  Should Be: "PrivateKey = %s"
  Status: QUICK FIX - ONE CHARACTER REMOVAL

ISSUE #8: ERROR IGNORED IN DISPLAYACCESSINFO/DISPLAYMANAGEMENTINFO
  Severity: MEDIUM
  Category: Silent Error Handling
  File: /home/user/homelab-coreos-minipc/homelab-setup/internal/steps/deployment.go
  Lines: 323, 351
  Function: DisplayAccessInfo() and DisplayManagementInfo()
  Problem: selectedServices, _ := d.GetSelectedServices()
  Count: 2 instances
  Status: FIX REQUIRED

ISSUE #9: REDUNDANT CONFIGURATION CHECK
  Severity: MEDIUM
  Category: Code Quality
  File: /home/user/homelab-coreos-minipc/homelab-setup/internal/steps/wireguard.go
  Lines: 48-54
  Function: configDir()
  Problem: Redundant empty string check after GetOrDefault()
  Status: REFACTOR

ISSUE #10: INCONSISTENT API USAGE - NFS
  Severity: MEDIUM
  Category: Inconsistency
  File: /home/user/homelab-coreos-minipc/homelab-setup/internal/steps/nfs.go
  Lines: 206 (os.ReadFile), 241 (fs.WriteFile)
  Problem: Mixes os.ReadFile and fs.WriteFile
  Status: STANDARDIZE

LOW SEVERITY ISSUES (Fix During Maintenance)
================================================================================

ISSUE #11: INCOMPLETE VALIDATION - COMPOSE COMMAND
  File: deployment.go, Lines: 211-214

ISSUE #12: HARDCODED PATH - WIREGUARD
  File: wireguard.go, Line: 287

ISSUE #13: UNCLEAR VARIABLE NAMING - NFS
  File: nfs.go, Lines: 244-248
  Variable: "w" should be "successMessage"

ISSUE #14: REDUNDANT TEST HELPER FUNCTION
  File: container_test.go, Lines: 233-245
  Issue: Custom contains() function reimplements strings.Contains()

ISSUE #15: TEST PARAMETER ERROR
  File: container_test.go, Line: 181
  Issue: Missing services parameter in NewDeployment() call

ISSUE #16: UNCHECKED ERROR IN TEST
  File: deployment_test.go, Line: 63
  Issue: cfg.Set() error not checked

ISSUE #17: POOR TEST ISOLATION
  File: container_test.go, Line: 24
  Issue: NewMarkers("") should be NewMarkers(t.TempDir())

ISSUE #18: FRAGILE TEST RUNNER
  File: nfs_config_test.go, Lines: 108-115
  Issue: Fake command runner doesn't handle spaces in arguments

ISSUE #19: INCOMPLETE VALIDATION
  File: deployment.go, Lines: 100-109
  Issue: Runtime not validated as installed

ISSUE #20: INCONSISTENT ERROR REPORTING
  File: deployment.go, Lines: 218, 290
  Issue: Mixed error/warning/info for same condition

ISSUE #21: MISSING INTEGRATION TESTS
  Files: All step files
  Issue: No tests for Run() method state transitions

ISSUE #22: TEST CONFIG POLLUTION
  File: container_test.go, Lines: 180-204
  Issue: Shared config state between tests

ISSUE #23: MISSING INPUT VALIDATION
  File: container.go, Lines: 418-440
  Issue: No validation for Nextcloud configuration inputs


SUMMARY BY FILE
================================================================================

wireguard.go (3 issues total)
  - MEDIUM: Line 184 - Config formatting error
  - MEDIUM: Lines 48-54 - Redundant code
  - LOW: Line 287 - Hardcoded path

nfs.go (4 issues total)
  - HIGH: Lines 251, 263 - Command injection vulnerability
  - MEDIUM: Lines 206, 241 - Inconsistent API usage
  - LOW: Lines 244-248 - Unclear variable naming

container.go (8 issues total)
  - HIGH: Lines 379, 388, 404, 422, 428, 434, 440, 451, 455, 466, 473, 480 - Unchecked errors
  - MEDIUM: Lines 60-68 - Silent errors
  - LOW: Lines 418-440 - Missing validation

deployment.go (6 issues total)
  - MEDIUM: Lines 198-205 - Working directory not restored
  - MEDIUM: Lines 323, 351 - Errors ignored
  - MEDIUM: Lines 100-109 - Incomplete validation
  - LOW: Lines 211-214 - Incomplete validation
  - LOW: Lines 218, 290 - Inconsistent error reporting

marker_helpers.go (1 issue total)
  - MEDIUM: Lines 7-38 - Race condition

container_test.go (5 issues total)
  - MEDIUM: Lines 220-231 - Test failure
  - MEDIUM: Lines 180-204 - Test pollution
  - LOW: Lines 233-245 - Code duplication
  - LOW: Line 181 - Missing parameter
  - LOW: Line 24 - Poor isolation

deployment_test.go (1 issue total)
  - LOW: Line 63 - Unchecked error

nfs_config_test.go (1 issue total)
  - LOW: Lines 108-115 - Fragile test

wireguard_config_test.go (0 issues)

steps_test.go (0 issues)

ALL FILES: (1 issue)
  - LOW: Missing integration tests


QUICK FIXES (< 1 hour each)
================================================================================

1. wireguard.go:184 - Remove leading space from " PrivateKey"
2. wireguard.go:48-54 - Simplify configDir() function
3. nfs.go:244-248 - Rename variable "w" to "successMessage"
4. container_test.go:233-245 - Replace contains() with strings.Contains()
5. deployment_test.go:63 - Add error check to cfg.Set()


MEDIUM EFFORT FIXES (1-4 hours each)
================================================================================

1. nfs.go:206 - Standardize to use fs.ReadFile() throughout
2. nfs.go:251, 263 - Implement command injection prevention
3. container.go:379, 388, 404, 422, 428, 434, 440, 451, 455, 466, 473, 480 - Add error checks
4. container.go:60-68 - Implement proper error handling in FindTemplateDirectory()
5. deployment.go:198-205 - Fix working directory restoration with error checking
6. marker_helpers.go:7-38 - Implement atomic marker operations
7. container_test.go:220-231 - Fix test isolation issues
8. container_test.go:24, 180-204 - Improve test setup


COMPREHENSIVE FIXES (4+ hours each)
================================================================================

1. Add integration tests for all Run() methods
2. Implement input validation throughout
3. Refactor error handling patterns
4. Add comprehensive logging


STATUS: All 23 issues documented and ready for developer assignment
REPORT DATE: 2025-11-13
NEXT REVIEW: After fixes are implemented

