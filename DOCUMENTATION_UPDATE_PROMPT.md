# Comprehensive Documentation Update Prompt for homelab-coreos-minipc

**Purpose**: Rewrite the homelab-coreos-minipc documentation to accurately reflect what's actually in the BlueBuild image and how it integrates with the homelab-setup CLI.

**Target Audience**: Users deploying the custom CoreOS image and contributors working on the project.

---

## 1. BlueBuild Recipe Structure and Image Build Process

### Document the Following:

**Recipe Architecture** (`recipes/recipe.yml`):
- Base image: `ghcr.io/ublue-os/ucore:stable`
- Module execution order matters:
  1. **Script Module**: Runs `install-rpmfusion-release.sh` to enable RPM Fusion repos
  2. **Packages Module**: Installs from `recipes/packages.yml` (Intel drivers, dev tools, CLI utilities)
  3. **Files Module**: Copies `files/system/` → image root `/` (binary, systemd units, configs, templates)
  4. **Systemd Module**: Enables services from `recipes/systemd.yml`
  5. **Signing Module**: Cosign image signing (if `SIGNING_SECRET` configured)

**Build Trigger Conditions**:
- Daily at 06:00 UTC (scheduled after UBlue upstream builds at 05:40 UTC)
- Push to main branch (ignores `*.md`, `docs/**`, `.github/**` changes)
- Pull requests (test build, no push)
- Manual dispatch

**Build Output**:
- Registry: `ghcr.io/zoro11031/homelab-coreos-minipc`
- Tags: `latest`, `{git-sha}`
- Signed variant: `ostree-image-signed:docker://` (if signing enabled)
- Unsigned variant: `ostree-unverified-registry:` (fallback)

**Critical Build Details**:
- All files in `files/system/` are copied to image root preserving directory structure
- Systemd units are only *enabled* if listed in `recipes/systemd.yml`
- The homelab-setup binary is updated separately (daily at 02:00 UTC) and committed before image build

---

## 2. System Services: Pre-installed vs. Setup-Created

### Pre-installed Services (Baked into Image)

**Always Enabled at Boot**:
- `wg-quick@wg0.service` - WireGuard VPN tunnel (requires `/etc/wireguard/wg0.conf` to actually start)
- `home-directory-setup.service` - Runs once at first boot (creates marker: `/var/home/core/.local/.home-setup-complete`)

**Installed but NOT Enabled** (user must enable during setup):
- `podman-compose-media.service` - Plex, Jellyfin, Tautulli (requires NFS mount)
- `podman-compose-web.service` - Nginx Proxy Manager, Overseerr, Wizarr, etc.
- `podman-compose-cloud.service` - Nextcloud, Immich, databases
- `docker-compose-media.service` - Docker variant
- `docker-compose-web.service` - Docker variant
- `docker-compose-cloud.service` - Docker variant

**Ignition-Created Services** (first boot only):
- `ucore-unsigned-autorebase.service` - Stage 1 rebase to unsigned custom image
- `ucore-signed-autorebase.service` - Stage 2 rebase to signed image (if available)

### Setup-Created Services (Generated by homelab-setup CLI)

**NFS Mount Units** (created during Step 4: NFS Setup):
- `mnt-nas-media.mount` - `/mnt/nas-media` → `{NFS_SERVER}:/mnt/storage/Media` (ro, nfsvers=4)
- `mnt-nas-nextcloud.mount` - `/mnt/nas-nextcloud` → `{NFS_SERVER}:/mnt/storage/Nextcloud` (rw, nfsvers=4)
- `mnt-nas-immich.mount` - `/mnt/nas-immich` → `{NFS_SERVER}:/mnt/storage/Immich` (rw, nfsvers=4)
- `mnt-nas-photos.mount` - `/mnt/nas-photos` → `{NFS_SERVER}:/mnt/storage/Photos` (ro, nfsvers=4)

**Important**: Media compose services have `Requires=mnt-nas-media.mount` dependency

---

## 3. Ignition/Butane Configuration Workflow

### Template Structure (`ignition/config.bu.template`)

**User Must Customize Before Deployment**:
- Replace `YOUR_SSH_PUB_KEY_HERE` with actual SSH public key
- Replace `YOUR_GOOD_PASSWORD_HASH_HERE` with yescrypt hash (generate with `./generate-password-hash.sh`)

**What Ignition Configures**:

1. **User Creation**:
   - Creates `core` user with SSH keys and password
   - Adds to groups: `wheel`, `docker`

2. **Hostname**:
   - Sets hostname to `homelab-minipc`

3. **Directory Creation**:
   - `/etc/ucore-autorebase/` (mode 0754) - for rebase marker files

4. **Auto-Rebase Process** (two-stage):
   - **Stage 1** (`ucore-unsigned-autorebase.service`):
     - Condition: `!/etc/ucore-autorebase/unverified` and `!/etc/ucore-autorebase/signed`
     - Rebases to: `ostree-unverified-registry:ghcr.io/zoro11031/homelab-coreos-minipc:latest`
     - Creates marker: `/etc/ucore-autorebase/unverified`
     - Disables self and reboots

   - **Stage 2** (`ucore-signed-autorebase.service`):
     - Condition: `/etc/ucore-autorebase/unverified` exists, `!/etc/ucore-autorebase/signed`
     - Rebases to: `ostree-image-signed:docker://ghcr.io/zoro11031/homelab-coreos-minipc:latest`
     - Creates marker: `/etc/ucore-autorebase/signed`
     - Disables self and reboots

**Deployment Workflow**:
1. User edits `config.bu.template` with SSH keys and password hash
2. Run `./ignition/transpile.sh` → generates `config.ign`
3. Host `config.ign` on web server or embed in ISO
4. Install Fedora CoreOS with Ignition config: `coreos-installer install --ignition-url http://...`
5. First boot: Auto-rebase happens automatically (2 reboots)
6. After rebases complete: `home-directory-setup.service` runs once
7. User SSH's in and runs `/usr/bin/homelab-setup`

---

## 4. Files Baked into Image and Their Purposes

### Complete Filesystem Overlay (`files/system/` → `/`)

**Compiled Binary**:
```
/usr/bin/homelab-setup (4.1MB Go binary)
```
- Source: `plex-migration-homelab/homelab-setup` (separate repo)
- Updated: Daily at 02:00 UTC via GitHub Actions
- Purpose: Main interactive setup CLI (replaces legacy bash scripts)

**GPU/VAAPI Configuration**:
```
/etc/profile.d/intel-vaapi.sh
```
```bash
export LIBVA_DRIVER_NAME=iHD
```
- Purpose: Sets Intel iHD driver for QuickSync hardware transcoding
- Applies globally to all shells

**Systemd Service Units**:
```
/etc/systemd/system/
├── wg-quick@.service              # WireGuard VPN (enabled, waits for config)
├── home-directory-setup.service   # First-boot setup (enabled, runs once)
├── podman-compose-media.service   # Media stack (disabled, user enables)
├── podman-compose-web.service     # Web stack (disabled, user enables)
├── podman-compose-cloud.service   # Cloud stack (disabled, user enables)
├── docker-compose-media.service   # Docker variant (disabled)
├── docker-compose-web.service     # Docker variant (disabled)
└── docker-compose-cloud.service   # Docker variant (disabled)
```

**Service Unit Details**:
- User: `dockeruser` (created during setup)
- WorkingDirectory: `/srv/containers`
- ExecStart: `/usr/bin/podman-compose -f {stack}.yml up -d`
- Dependencies: `network-online.target`, `mnt-nas-*.mount` (for media services)

**Docker Compose Templates**:
```
/usr/share/compose-setup/
├── media.yml    # Plex, Jellyfin, Tautulli (with /dev/dri GPU access)
├── web.yml      # Nginx Proxy Manager, Overseerr, Wizarr, Organizr, Homepage
├── cloud.yml    # Nextcloud, Immich, PostgreSQL, Redis, Collabora
└── .env.example # Environment variable template
```

**Compose Template Features**:
- Use environment variables: `${PUID}`, `${PGID}`, `${TZ}`, `${APPDATA_PATH}`
- Intel QuickSync: `devices: [/dev/dri:/dev/dri]` for Plex/Jellyfin
- NFS mounts: `/mnt/nas-media:/media:ro` (read-only)
- Watchtower labels: `com.centurylinklabs.watchtower.enable=true`

**WireGuard Setup Scripts**:
```
/usr/share/wireguard-setup/
├── wg0.conf.template       # Multi-peer WireGuard config template
├── generate-keys.sh        # Interactive key generation wizard
├── apply-config.sh         # Fills template with keys/IPs
└── export-peer-configs.sh  # Generates peer config files
```

**First-Boot Setup Scripts**:
```
/usr/share/setup-scripts/
├── dotfiles.sh   # Copies /usr/share/bluebuild/dotfiles/ → /home/core/
├── compose.sh    # Creates /srv/containers, /var/lib/containers/appdata, copies templates
└── wireguard.sh  # Copies WireGuard setup scripts to ~/setup/wireguard-setup/
```

**Legacy Bash Setup Scripts** (deprecated, use `/usr/bin/homelab-setup` instead):
```
/usr/share/home-lab-setup-scripts/
├── homelab-setup.sh              # Main menu TUI
└── scripts/
    ├── common-functions.sh       # Shared utilities (logging, validation)
    ├── 00-preflight-check.sh     # System validation
    ├── 01-user-setup.sh          # User/group creation
    ├── 02-directory-setup.sh     # Directory structure
    ├── 03-wireguard-setup.sh     # WireGuard configuration
    ├── 04-nfs-setup.sh           # NFS mount units
    ├── 05-container-setup.sh     # Compose environment
    ├── 06-service-deployment.sh  # Service enablement
    └── troubleshoot.sh           # Diagnostics
```

**Dotfiles** (copied to core user at first boot):
```
/usr/share/bluebuild/dotfiles/
├── .bashrc, .zshrc, .vimrc, .p10k.zsh
└── .config/
    ├── ghostty/, git/, kitty/
    ├── nvim/, tmux/
    └── (other tool configs)
```

---

## 5. Relationship Between This Repo and homelab-setup

### Binary Build and Update Workflow

**Separate Repository**:
- Go source code: `https://github.com/plex-migration-homelab/homelab-setup`
- This repo: BlueBuild configuration only (no Go source)

**Automated Binary Build** (`.github/workflows/build-homelab-setup.yml`):

1. **Triggers**:
   - Daily at 02:00 UTC (4 hours before image build)
   - Push to main if workflow file changes
   - Manual dispatch

2. **Build Process**:
   - Checks out this BlueBuild repo
   - Checks out homelab-setup source to temp directory
   - Sets up Go 1.23
   - Runs tests: `go test ./... -v`
   - Builds binary: `make build` (produces `bin/homelab-setup`)
   - Copies to: `files/system/usr/bin/homelab-setup`

3. **Auto-Commit**:
   - If binary changed, commits with: `chore: rebuild homelab-setup binary [skip ci]`
   - Uses `GH_PAT` secret for authentication
   - Pushes to main branch

4. **Artifact Upload**:
   - Uploads binary as GitHub artifact (30-day retention)
   - Available for manual download

**Integration Points**:
- Binary is part of filesystem overlay (`files/system/usr/bin/homelab-setup`)
- Gets baked into image during BlueBuild process
- Users run it post-installation to complete setup

**Version Checking**:
- Binary includes version info from Go build
- User can check with: `/usr/bin/homelab-setup version`
- No automatic update mechanism (user rebases to new image)

---

## 6. Actual Filesystem Layout Post-Installation

### System Directories

**Immutable OS Layer** (rpm-ostree):
```
/usr/bin/homelab-setup                # Go binary (baked in)
/usr/bin/podman-compose              # Installed package
/usr/share/compose-setup/            # Templates (baked in)
/usr/share/wireguard-setup/          # WireGuard scripts (baked in)
/usr/share/home-lab-setup-scripts/   # Legacy bash scripts (baked in)
/usr/share/bluebuild/dotfiles/       # Dotfiles (baked in)
/etc/profile.d/intel-vaapi.sh        # GPU env vars (baked in)
/etc/systemd/system/*.service        # Service units (baked in)
```

**Mutable Configuration** (user-created):
```
/etc/wireguard/wg0.conf              # Generated by homelab-setup
/etc/systemd/system/*.mount          # NFS mount units (generated by homelab-setup)
```

**Container Storage**:
```
/srv/containers/                     # Created at first boot
├── media.yml                        # Copied from /usr/share/compose-setup/
├── web.yml
├── cloud.yml
└── .env                             # Generated by homelab-setup

/var/lib/containers/appdata/         # Created at first boot
├── plex/                            # Persistent container data
├── jellyfin/
├── tautulli/
├── overseerr/
├── wizarr/
├── organizr/
├── homepage/
├── nextcloud/
├── immich/
├── postgres/
└── redis/
```

**NFS Mount Points** (created by homelab-setup):
```
/mnt/nas-media/                      # NFS mount (ro)
/mnt/nas-nextcloud/                  # NFS mount (rw)
/mnt/nas-immich/                     # NFS mount (rw)
/mnt/nas-photos/                     # NFS mount (ro)
```

**User Home Directory**:
```
/var/home/core/
├── .bashrc, .zshrc, .vimrc          # Copied at first boot
├── .config/                         # Copied at first boot
├── .homelab-setup.conf              # Generated by homelab-setup
├── .local/
│   ├── .home-setup-complete         # Marker for home-directory-setup.service
│   └── homelab-setup/               # Completion markers (created by homelab-setup)
│       ├── preflight-complete
│       ├── user-setup-complete
│       ├── directory-setup-complete
│       ├── wireguard-setup-complete
│       ├── nfs-setup-complete
│       ├── container-setup-complete
│       └── service-deployment-complete
└── setup/                           # Created at first boot
    ├── compose-setup/               # Templates for reference
    ├── wireguard-setup/             # Key generation scripts
    └── home-lab-setup-scripts/      # Legacy bash scripts
```

**Service User Home** (created during setup):
```
/var/home/dockeruser/                # Created by homelab-setup
└── (minimal - services run from /srv/containers)
```

---

## 7. All Systemd Service Units Included

### Pre-installed Services (from `files/system/etc/systemd/system/`)

**WireGuard VPN**:
```ini
# wg-quick@.service (enabled via recipes/systemd.yml)
[Unit]
Description=WireGuard via wg-quick(8) for %I
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/wg-quick up %i
ExecStop=/usr/bin/wg-quick down %i

[Install]
WantedBy=multi-user.target
```
- Enabled at boot, but waits for `/etc/wireguard/wg0.conf` (created during setup)
- Instance name: `wg-quick@wg0.service`

**First-Boot Setup**:
```ini
# home-directory-setup.service (enabled via recipes/systemd.yml)
[Unit]
Description=Home directory setup for core user
After=multi-user.target
ConditionPathExists=!/var/home/core/.local/.home-setup-complete

[Service]
Type=oneshot
ExecStart=/bin/bash /usr/share/setup-scripts/dotfiles.sh
ExecStart=/bin/bash /usr/share/setup-scripts/compose.sh
ExecStart=/bin/bash /usr/share/setup-scripts/wireguard.sh
ExecStartPost=/usr/bin/touch /var/home/core/.local/.home-setup-complete
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```
- Runs once (marker prevents re-run)
- Copies dotfiles, creates directories, deploys templates

**Podman Compose Services** (disabled by default):
```ini
# podman-compose-media.service
[Unit]
Description=Podman Compose - Media Stack
Requires=network-online.target mnt-nas-media.mount
After=network-online.target mnt-nas-media.mount

[Service]
Type=oneshot
RemainAfterExit=yes
User=dockeruser
Group=dockeruser
WorkingDirectory=/srv/containers
ExecStart=/usr/bin/podman-compose -f media.yml up -d
ExecStop=/usr/bin/podman-compose -f media.yml down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
```

```ini
# podman-compose-web.service
[Unit]
Description=Podman Compose - Web Stack
Requires=network-online.target
After=network-online.target

[Service]
Type=oneshot
RemainAfterExit=yes
User=dockeruser
Group=dockeruser
WorkingDirectory=/srv/containers
ExecStart=/usr/bin/podman-compose -f web.yml up -d
ExecStop=/usr/bin/podman-compose -f web.yml down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
```

```ini
# podman-compose-cloud.service
[Unit]
Description=Podman Compose - Cloud Stack
Requires=network-online.target
After=network-online.target

[Service]
Type=oneshot
RemainAfterExit=yes
User=dockeruser
Group=dockeruser
WorkingDirectory=/srv/containers
ExecStart=/usr/bin/podman-compose -f cloud.yml up -d
ExecStop=/usr/bin/podman-compose -f cloud.yml down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
```

**Docker Variants** (identical structure, use `/usr/bin/docker-compose`):
- `docker-compose-media.service`
- `docker-compose-web.service`
- `docker-compose-cloud.service`

### Setup-Generated Services (created by homelab-setup)

**NFS Mount Units** (example: `mnt-nas-media.mount`):
```ini
[Unit]
Description=NFS mount for media
After=network-online.target
Wants=network-online.target

[Mount]
What=192.168.7.10:/mnt/storage/Media
Where=/mnt/nas-media
Type=nfs
Options=ro,nfsvers=4,soft,timeo=30,retrans=2

[Install]
WantedBy=multi-user.target
```
- Generated during Step 4: NFS Setup
- Similar units for: `mnt-nas-nextcloud.mount`, `mnt-nas-immich.mount`, `mnt-nas-photos.mount`

---

## 8. VAAPI/GPU Driver Configuration

### Intel QuickSync Hardware Transcoding Stack

**Installed Packages** (`recipes/packages.yml`):
- `intel-media-driver` - Intel Media Driver (iHD) for Gen 8+ GPUs
- `libva` - Video Acceleration API (VAAPI) core library
- `libva-utils` - Utilities including `vainfo` for testing
- `ffmpeg` - Hardware-accelerated encoding/decoding
- `gstreamer1-vaapi` - GStreamer VAAPI plugin

**Environment Configuration** (`/etc/profile.d/intel-vaapi.sh`):
```bash
export LIBVA_DRIVER_NAME=iHD
```
- Sets Intel iHD driver globally (loads at shell startup)
- Applies to all users and services

**Container Integration** (Docker Compose):
```yaml
# Example from media.yml
services:
  plex:
    environment:
      - LIBVA_DRIVER_NAME=iHD  # Redundant but explicit
    devices:
      - /dev/dri:/dev/dri      # Intel QuickSync device
```

**Verification Commands**:
```bash
# On host
vainfo

# In container
docker exec -it plex vainfo
podman exec -it jellyfin vainfo
```

**Expected Output**:
```
libva info: VA-API version 1.x.x
libva info: Driver version: Intel iHD driver for Intel(R) Gen Graphics - x.x.x
vainfo: Supported profile and entrypoints
      VAProfileH264Main               : VAEntrypointVLD
      VAProfileH264Main               : VAEntrypointEncSlice
      VAProfileHEVCMain               : VAEntrypointVLD
      VAProfileHEVCMain               : VAEntrypointEncSlice
      ...
```

**Supported Codecs** (Intel Gen 8+):
- H.264 (AVC): Decode, Encode
- H.265 (HEVC): Decode, Encode
- VP9: Decode (Gen 9+)
- AV1: Decode (Gen 11+, Xe)

---

## 9. home-directory-setup.service Detailed Breakdown

### Service Definition

```ini
[Unit]
Description=Home directory setup for core user
After=multi-user.target
ConditionPathExists=!/var/home/core/.local/.home-setup-complete

[Service]
Type=oneshot
ExecStart=/bin/bash /usr/share/setup-scripts/dotfiles.sh
ExecStart=/bin/bash /usr/share/setup-scripts/compose.sh
ExecStart=/bin/bash /usr/share/setup-scripts/wireguard.sh
ExecStartPost=/usr/bin/touch /var/home/core/.local/.home-setup-complete
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

### Execution Flow

**Condition Check**:
- Only runs if `/var/home/core/.local/.home-setup-complete` does NOT exist
- After first run, creates marker to prevent re-execution

**Script 1: dotfiles.sh**:
```bash
#!/bin/bash
# Copy dotfiles from image to core user home
cp -r /usr/share/bluebuild/dotfiles/. /home/core/
chown -R core:core /home/core
```
- Copies: `.bashrc`, `.zshrc`, `.vimrc`, `.p10k.zsh`, `.config/`
- Sets ownership to `core:core`
- User has working shell environment immediately

**Script 2: compose.sh**:
```bash
#!/bin/bash
# Create setup directory with templates
mkdir -p /home/core/setup
cp -r /usr/share/compose-setup /home/core/setup
cp -r /usr/share/home-lab-setup-scripts /home/core/setup
chown -R core:core /home/core/setup

# Create production compose directory
mkdir -p /srv/containers
cp /usr/share/compose-setup/*.yml /srv/containers/
cp /usr/share/compose-setup/.env.example /srv/containers/.env.example

# Create appdata directories
mkdir -p /var/lib/containers/appdata/{plex,jellyfin,tautulli,overseerr,wizarr,organizr,homepage,nextcloud,immich,postgres,redis}

# Set temporary ownership (will be changed to dockeruser later)
chown -R core:core /srv/containers
chown -R core:core /var/lib/containers/appdata
```
- User can reference templates in `~/setup/compose-setup/`
- Production compose files ready in `/srv/containers/`
- Appdata directories pre-created (ownership changed during user setup)

**Script 3: wireguard.sh**:
```bash
#!/bin/bash
# Copy WireGuard setup scripts
mkdir -p /home/core/setup/wireguard-setup
cp -r /usr/share/wireguard-setup/. /home/core/setup/wireguard-setup/
chown -R core:core /home/core/setup
```
- User can run `~/setup/wireguard-setup/generate-keys.sh` interactively

**Marker Creation**:
- Touches `/var/home/core/.local/.home-setup-complete`
- Service won't run on subsequent boots

### Why This Service Exists

**Problem**: CoreOS is immutable, user home directories are mutable
- Can't pre-populate user homes during image build
- Need to copy files from `/usr/share/` to `/var/home/` at first boot

**Solution**: One-time systemd service
- Runs after system is fully booted (`After=multi-user.target`)
- Idempotent (condition prevents re-run)
- Prepares environment before user logs in

---

## 10. Network Configuration Defaults and Application

### Default Network Settings

**Hostname** (set via Ignition):
```yaml
storage:
  files:
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: homelab-minipc
```

**Network Manager** (Fedora CoreOS default):
- DHCP enabled by default
- User configures static IP via `nmcli` or `/etc/NetworkManager/system-connections/`

**Firewall** (firewalld):
- Default zone: `public`
- Ports opened by services as needed:
  - Plex: 32400/tcp
  - Jellyfin: 8096/tcp
  - Nginx: 80/tcp, 443/tcp

### WireGuard VPN Configuration

**Default Subnet**: `10.253.0.0/24`

**Server (Mini PC)**: `10.253.0.1/24`

**Peers** (from `wg0.conf.template`):
```ini
[Interface]
Address = 10.253.0.1/24
ListenPort = 51820
PrivateKey = SERVER_PRIVATE_KEY

# Desktop
[Peer]
PublicKey = DESKTOP_PUBLIC_KEY
AllowedIPs = 10.253.0.6/32

# VPS (for reverse proxy)
[Peer]
PublicKey = VPS_PUBLIC_KEY
AllowedIPs = 10.253.0.8/32

# iPhone
[Peer]
PublicKey = IPHONE_PUBLIC_KEY
AllowedIPs = 10.253.0.9/32

# Laptop
[Peer]
PublicKey = LAPTOP_PUBLIC_KEY
AllowedIPs = 10.253.0.11/32
```

**NAT/IP Forwarding**:
```ini
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o enp1s0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o enp1s0 -j MASQUERADE
```
- Adjust `enp1s0` to actual interface name
- Enables routing between peers

**How Configuration is Applied**:
1. User runs `/usr/bin/homelab-setup` → Step 3: WireGuard Setup
2. Wizard prompts for:
   - Server endpoint (public IP or DDNS)
   - Peer names and IPs
3. Generates keys with `generate-keys.sh`
4. Fills template with `apply-config.sh` → `/etc/wireguard/wg0.conf`
5. Enables service: `systemctl enable --now wg-quick@wg0.service`

### Container Networking

**Media Stack** (host network mode):
```yaml
services:
  plex:
    network_mode: host
  jellyfin:
    ports:
      - "8096:8096"
```
- Direct WAN access (no NAT traversal issues)
- Uses host's IP address

**Web/Cloud Stacks** (bridge network):
```yaml
networks:
  web:
    driver: bridge
```
- Isolated from host network
- Access via Nginx Proxy Manager reverse proxy

---

## 11. Legacy Bash Scripts vs. Go CLI Relationship

### Feature Parity Matrix

| Feature | Legacy Bash (`homelab-setup.sh`) | Go CLI (`/usr/bin/homelab-setup`) | Status |
|---------|----------------------------------|-----------------------------------|--------|
| Preflight check | ✅ `00-preflight-check.sh` | ✅ `cmd/preflight.go` | **Both work** |
| User setup | ✅ `01-user-setup.sh` | ✅ `cmd/user.go` | **Both work** |
| Directory setup | ✅ `02-directory-setup.sh` | ✅ `cmd/directory.go` | **Both work** |
| WireGuard setup | ✅ `03-wireguard-setup.sh` | ✅ `cmd/wireguard.go` | **Both work** |
| NFS setup | ✅ `04-nfs-setup.sh` | ✅ `cmd/nfs.go` | **Both work** |
| Container setup | ✅ `05-container-setup.sh` | ✅ `cmd/container.go` | **Both work** |
| Service deployment | ✅ `06-service-deployment.sh` | ✅ `cmd/deploy.go` | **Both work** |
| Troubleshooting | ✅ `troubleshoot.sh` | ✅ `cmd/status.go` | **Both work** |
| Input validation | ⚠️ Basic regex | ✅ Comprehensive (IP/port/CIDR/path) | **Go CLI better** |
| Error handling | ⚠️ Exit on error | ✅ Graceful recovery, colored output | **Go CLI better** |
| Config file | ✅ `~/.homelab-setup.conf` | ✅ `~/.homelab-setup.conf` | **Same format** |
| Completion markers | ✅ `~/.local/homelab-setup/` | ✅ `~/.local/homelab-setup/` | **Same location** |

### Shared Configuration Format

Both tools use the same INI-style config file:
```ini
# ~/.homelab-setup.conf
CONTAINER_RUNTIME=podman
HOMELAB_USER=dockeruser
PUID=1001
PGID=1001
TZ=America/Chicago
NFS_SERVER=192.168.7.10
NFS_MEDIA_PATH=/volume1/media
WG_SERVER_ENDPOINT=vpn.example.com:51820
```

### Why Both Exist

**Historical Context**:
- Original implementation: Bash scripts (2024)
- Migration to Go: November 2025
- Bash scripts kept for backward compatibility and reference

**Advantages of Go CLI**:
- Better error handling and validation
- Colored terminal output (better UX)
- Easier to test (unit tests)
- Maintained in separate repo (cleaner architecture)
- Cross-platform compilation (though only Linux is targeted)

**When to Use Which**:
- **Recommended**: Go CLI (`/usr/bin/homelab-setup`)
- **Legacy**: Bash scripts (`~/setup/home-lab-setup-scripts/homelab-setup.sh`)
- **Development**: Go CLI (active development, bash scripts frozen)

### Migration Path

Users can safely switch between tools:
1. Both read the same config file
2. Both create identical systemd units
3. Both use the same completion markers
4. No data loss when switching

---

## 12. Breaking Changes Between Image Versions

### Version Tracking

**No Formal Versioning**: Images are tagged by date/commit SHA, not semantic versions

**Current Tagging**:
- `latest` - Most recent build
- `{git-sha}` - Specific commit (e.g., `c92a78b`)

### Potential Breaking Changes to Document

**Migration from Legacy to Go CLI** (November 2025):
- **Change**: Binary path changed from multiple bash scripts to single Go binary
- **Impact**: Users must use `/usr/bin/homelab-setup` instead of `~/setup/home-lab-setup-scripts/homelab-setup.sh`
- **Migration**: None required (config file format unchanged)
- **Backward Compatibility**: Bash scripts still included in image

**homelab-setup Source Moved to Separate Repo** (November 2025):
- **Change**: Go source code moved to `plex-migration-homelab/homelab-setup`
- **Impact**: Contributors must work in separate repo for CLI changes
- **Migration**: None required for users
- **Backward Compatibility**: Binary still bundled in image

**Systemd Service User Changed** (Historical):
- **Change**: Services originally ran as `core`, now run as `dockeruser`
- **Impact**: Users must chown `/srv/containers` and `/var/lib/containers/appdata` to `dockeruser:dockeruser`
- **Migration**: Run `sudo chown -R dockeruser:dockeruser /srv/containers /var/lib/containers/appdata`
- **Detection**: Check `User=` in service files

**NFS Mount Options Standardized** (Historical):
- **Change**: Switched from `vers=4` to `nfsvers=4` for compatibility
- **Impact**: Existing `.mount` units may fail on reboot
- **Migration**: Regenerate mount units with homelab-setup Step 4
- **Detection**: Check `/etc/systemd/system/*.mount` for `vers=` vs `nfsvers=`

**Auto-Rebase Process Formalized** (Historical):
- **Change**: Added two-stage rebase (unsigned → signed)
- **Impact**: First boot takes 2 reboots instead of 1
- **Migration**: None required (Ignition config handles it)
- **Backward Compatibility**: Old Ignition configs still work (single rebase)

### Breaking Changes Checklist for New Versions

When releasing new images, check:
1. **Config file format**: Did keys change in `~/.homelab-setup.conf`?
2. **Systemd unit paths**: Did service file locations move?
3. **Compose template format**: Did environment variables change?
4. **Binary location**: Did executable paths change?
5. **Completion markers**: Did marker file paths change?
6. **NFS mount options**: Did mount unit syntax change?
7. **WireGuard config**: Did template format change?

---

## 13. Troubleshooting Paths for Common Post-Install Issues

### Issue 1: Auto-Rebase Failed

**Symptoms**:
- System boots to stock Fedora CoreOS (not custom image)
- `rpm-ostree status` shows `fedora/x86_64/coreos/stable`

**Diagnosis**:
```bash
# Check rebase service status
systemctl status ucore-unsigned-autorebase.service
systemctl status ucore-signed-autorebase.service

# Check markers
ls -la /etc/ucore-autorebase/
```

**Common Causes**:
- Network connectivity during first boot
- Registry authentication issues
- Incorrect image URL in Ignition config

**Resolution**:
```bash
# Manual rebase
sudo rpm-ostree rebase ostree-unverified-registry:ghcr.io/zoro11031/homelab-coreos-minipc:latest
sudo systemctl reboot

# After reboot, check status
rpm-ostree status
```

---

### Issue 2: home-directory-setup.service Didn't Run

**Symptoms**:
- No dotfiles in `/home/core/`
- No `/srv/containers/` directory
- No `~/setup/` directory

**Diagnosis**:
```bash
# Check service status
systemctl status home-directory-setup.service

# Check marker
ls -la /var/home/core/.local/.home-setup-complete

# View logs
journalctl -u home-directory-setup.service
```

**Common Causes**:
- Marker file exists (service already ran and failed)
- Permissions issue with `/var/home/core/`

**Resolution**:
```bash
# Remove marker and rerun
sudo rm /var/home/core/.local/.home-setup-complete
sudo systemctl start home-directory-setup.service

# Check status
systemctl status home-directory-setup.service
```

---

### Issue 3: WireGuard Won't Start

**Symptoms**:
- `systemctl status wg-quick@wg0.service` shows failed
- No `wg0` interface when running `ip a`

**Diagnosis**:
```bash
# Check service status
systemctl status wg-quick@wg0.service

# Check config file
sudo cat /etc/wireguard/wg0.conf

# Manual start for verbose output
sudo wg-quick up wg0
```

**Common Causes**:
- Missing `/etc/wireguard/wg0.conf` (not created during setup)
- Invalid key format in config
- Port 51820 already in use
- Firewall blocking UDP 51820

**Resolution**:
```bash
# Create config with setup wizard
cd ~/setup/wireguard-setup
./generate-keys.sh
./apply-config.sh

# Copy to system location
sudo cp wg0.conf /etc/wireguard/wg0.conf
sudo chmod 600 /etc/wireguard/wg0.conf

# Restart service
sudo systemctl restart wg-quick@wg0.service
```

---

### Issue 4: NFS Mounts Failing

**Symptoms**:
- `systemctl status mnt-nas-media.mount` shows failed
- `/mnt/nas-media/` is empty
- Media services won't start

**Diagnosis**:
```bash
# Check mount status
systemctl status mnt-nas-media.mount

# Manual mount test
sudo mount -t nfs -o ro,nfsvers=4 192.168.7.10:/mnt/storage/Media /mnt/nas-media

# Check NFS server connectivity
showmount -e 192.168.7.10
```

**Common Causes**:
- NFS server unreachable
- Incorrect NFS export path
- Firewall blocking NFS ports (2049)
- NFSv4 not enabled on server

**Resolution**:
```bash
# Verify NFS server exports
showmount -e 192.168.7.10

# Re-run NFS setup with correct path
/usr/bin/homelab-setup
# Select: 4 - NFS Setup

# Check mount unit
cat /etc/systemd/system/mnt-nas-media.mount

# Reload and restart
sudo systemctl daemon-reload
sudo systemctl restart mnt-nas-media.mount
```

---

### Issue 5: Compose Services Won't Start

**Symptoms**:
- `systemctl status podman-compose-media.service` shows failed
- Containers not running when checking `podman ps`

**Diagnosis**:
```bash
# Check service status
systemctl status podman-compose-media.service

# Check service user
id dockeruser

# Check directory ownership
ls -ld /srv/containers
ls -ld /var/lib/containers/appdata

# Manual compose test
cd /srv/containers
sudo -u dockeruser podman-compose -f media.yml up -d
```

**Common Causes**:
- `dockeruser` doesn't exist (user setup not completed)
- Wrong ownership on `/srv/containers` or appdata directories
- Missing `.env` file
- NFS mounts not available (dependency failure)
- Podman socket not running

**Resolution**:
```bash
# Re-run user setup
/usr/bin/homelab-setup
# Select: 1 - User Setup

# Fix ownership
sudo chown -R dockeruser:dockeruser /srv/containers
sudo chown -R dockeruser:dockeruser /var/lib/containers/appdata

# Ensure NFS mounts are up
sudo systemctl start mnt-nas-media.mount

# Restart service
sudo systemctl restart podman-compose-media.service

# Check logs
journalctl -u podman-compose-media.service -n 50
```

---

### Issue 6: Intel QuickSync Not Working

**Symptoms**:
- Plex/Jellyfin transcoding falls back to software
- High CPU usage during playback
- `/dev/dri` not accessible in containers

**Diagnosis**:
```bash
# Check GPU device
ls -l /dev/dri

# Check VAAPI driver
vainfo

# Check in container
podman exec -it plex vainfo
podman exec -it jellyfin ls -l /dev/dri
```

**Common Causes**:
- `/dev/dri` not mapped in compose file
- Wrong VAAPI driver (i965 vs iHD)
- Incorrect permissions on `/dev/dri`
- Intel media driver not installed

**Resolution**:
```bash
# Verify driver installation
rpm -qa | grep intel-media-driver

# Check environment variable
echo $LIBVA_DRIVER_NAME  # Should be "iHD"

# Ensure compose file has device mapping
cat /srv/containers/media.yml | grep -A2 "devices:"
# Should show: - /dev/dri:/dev/dri

# Fix permissions (if needed)
sudo chmod 666 /dev/dri/renderD128

# Restart containers
sudo systemctl restart podman-compose-media.service
```

---

### Issue 7: Binary Updates Not Applied

**Symptoms**:
- `/usr/bin/homelab-setup version` shows old version
- Expected features not available

**Diagnosis**:
```bash
# Check current deployment
rpm-ostree status

# Check image build date
podman run --rm ghcr.io/zoro11031/homelab-coreos-minipc:latest cat /etc/os-release
```

**Common Causes**:
- System not rebased to latest image
- Image build failed (check GitHub Actions)
- User running old binary from `~/setup/` instead of `/usr/bin/`

**Resolution**:
```bash
# Rebase to latest
sudo rpm-ostree rebase ghcr.io/zoro11031/homelab-coreos-minipc:latest
sudo systemctl reboot

# After reboot, verify
/usr/bin/homelab-setup version
rpm-ostree status
```

---

### Diagnostic Commands Reference

**System Status**:
```bash
rpm-ostree status                    # Check current deployment
systemctl list-units --state=failed  # Show failed services
journalctl -xe                       # View recent logs
```

**Network**:
```bash
ip a                                 # Show interfaces (check wg0)
ping 192.168.7.10                    # Test NFS server connectivity
wg show                              # Show WireGuard status
```

**Storage**:
```bash
df -h                                # Check disk space
mount | grep nfs                     # Show NFS mounts
ls -la /srv/containers               # Check compose directory
```

**Containers**:
```bash
podman ps -a                         # List all containers
podman logs <container>              # View container logs
podman-compose -f media.yml ps       # Check compose stack status
```

**GPU**:
```bash
vainfo                               # Test VAAPI
lspci | grep VGA                     # Show GPU
ls -l /dev/dri                       # Check device permissions
```

---

## Documentation Structure Recommendations

### Proposed Documentation Hierarchy

```
docs/
├── README.md                        # Overview and quickstart
├── installation/
│   ├── 01-preparation.md            # Ignition config customization
│   ├── 02-installation.md           # CoreOS installation process
│   ├── 03-first-boot.md             # Auto-rebase walkthrough
│   └── 04-setup-wizard.md           # homelab-setup CLI usage
├── architecture/
│   ├── bluebuild-recipe.md          # Build process deep dive
│   ├── filesystem-layout.md         # Where files live
│   ├── systemd-services.md          # All service units explained
│   └── network-architecture.md      # WireGuard, NFS, container networking
├── services/
│   ├── media-stack.md               # Plex, Jellyfin configuration
│   ├── web-stack.md                 # Nginx, Overseerr, etc.
│   ├── cloud-stack.md               # Nextcloud, Immich
│   └── gpu-transcoding.md           # Intel QuickSync setup
├── maintenance/
│   ├── updates.md                   # How to update the image
│   ├── backup-restore.md            # Backup strategies
│   └── troubleshooting.md           # Issue resolution guide (this section)
└── development/
    ├── building-images.md           # Local BlueBuild testing
    ├── binary-development.md        # Contributing to homelab-setup CLI
    └── ci-cd-pipeline.md            # GitHub Actions workflows
```

### Key Documentation Principles

1. **Separate "What's Baked In" from "What User Configures"**
   - Make it crystal clear which files are immutable (in image)
   - Which files are user-generated (via homelab-setup)

2. **Visual Diagrams**:
   - Boot sequence flowchart (Ignition → Auto-rebase → home-directory-setup → user setup)
   - Network topology (WireGuard tunnel to VPS, NFS mounts, container networking)
   - Filesystem hierarchy (immutable vs mutable layers)

3. **Command Examples**:
   - Always show actual commands with expected output
   - Include troubleshooting variations

4. **Version-Specific Notes**:
   - Clearly mark when features were added/changed
   - Provide migration guides for breaking changes

---

## Success Criteria for Updated Documentation

The documentation is complete when a new user can:

1. ✅ Understand the difference between BlueBuild config repo and homelab-setup CLI repo
2. ✅ Customize Ignition config without errors
3. ✅ Install CoreOS and understand the auto-rebase process
4. ✅ Know which services start automatically vs which require setup
5. ✅ Complete the homelab-setup wizard successfully
6. ✅ Troubleshoot common issues without asking for help
7. ✅ Update to new image versions safely
8. ✅ Contribute to either repo with clear understanding of architecture

And a developer can:

1. ✅ Modify BlueBuild recipes and test locally
2. ✅ Understand how binary updates integrate with image builds
3. ✅ Add new systemd services correctly
4. ✅ Contribute to homelab-setup CLI in separate repo
5. ✅ Debug CI/CD pipeline issues

---

## Next Steps

1. **Audit Existing Documentation**:
   - Compare current docs against this analysis
   - Identify gaps and inaccuracies

2. **Rewrite Priority**:
   - High: Installation guide, architecture overview, troubleshooting
   - Medium: Service configuration, maintenance
   - Low: Development guides (defer to CLAUDE.md)

3. **Create Missing Docs**:
   - Filesystem layout visualization
   - Boot sequence flowchart
   - Network topology diagram
   - Systemd service dependency graph

4. **Validation**:
   - Test installation guide end-to-end in VM
   - Verify all commands in troubleshooting section
   - Have new user review for clarity

---

**End of Documentation Update Prompt**
